{{- $toot := or .Params.toot  .Params.mstd .Params.mastodon }}
{{- $bsky := or .Params.skeet .Params.bsky .Params.bluesky }}
{{- if or $toot $bsky -}}
<details id="comments" class="presentation textwidth" aria-label="{{ i18n "comments" }}"
    data-i18n-noComment="{{ i18n "noComment" }}"
    data-i18n-err="{{ i18n "fediverseErr" }}"
    data-i18n-loading="{{ i18n "fediverseIsLoading" }}"
    data-i18n-replies="{{ i18n "fediverseReplies" }}"
    data-i18n-reblogs="{{ i18n "fediverseReblogs" }}"
    data-i18n-favourites="{{ i18n "fediverseFavourites" }}"
    open>
    <summary>
        <strong>{{ i18n "comments" }}</strong>
        <div id="stats" class="stat" aria-live="polite"></div>
    </summary>

    <article id="discussion-starter">
        <div id="discussion-starter-content">
            <noscript>
                <div id="comments-error" role="alert">{{ i18n "noScript" }} {{ i18n "noComment" }}</div>
            </noscript>
        </div>
        <nav aria-label="{{ i18n "ctaComments" }}">
            {{- $cta := cond $toot $toot $bsky }}
            <a id="join-discussion" href="{{ $cta }}" class="{{ if $toot }}mstd{{ else }}bsky{{ end }}" rel="nofollow" aria-label="{{ i18n "ctaComments" }}">
                <i class="icon {{ if $toot }}mastodon{{ else }}bluesky{{ end }}" style="padding-right: 3pt;"></i><span>{{ i18n "ctaComments" }}</span>
            </a>
            {{- if and $toot $bsky }}
                <a id="join-discussion-bluesky" href="{{ $bsky }}" class="bsky" rel="nofollow" aria-label="{{ i18n "fediverseBluesky" }}" title="{{ i18n "fediverseBluesky" }}">
                    <i class="icon bluesky"></i>
                </a>
            {{- end }}
        </nav>
    </article>

    {{ with $toot }}
        <ul id="mstd-comments" aria-busy="true" aria-label="{{ i18n "comments" }}"
            data-url="{{ . }}"></ul>
    {{ end }}
    {{- with $bsky }}
        <ul id="bsky-comments" aria-busy="true" aria-label="{{ i18n "comments" }}"
            data-url="{{ . }}"></ul>
    {{- end }}

    {{- if and $toot $bsky }}
        <ul id="fed-comments" aria-busy="false" aria-label="{{ i18n "comments" }}" ></ul>
    {{- end }}

    {{/*  {{- if not site.Params.disableDOMPurify }}
        <script src="https://cdn.jsdelivr.net/npm/dompurify@3.2.6/dist/purify.min.js" referrerpolicy="no-referrer"
            integrity="sha256-ieH6dkfLSVNw06mXrOQ4f10V2fTFrxI1LFPapACVYoc=" crossorigin="anonymous" defer></script>
    {{- end }}  */}}
    {{ partialCached "fediscuss/js.html" . }}
</details>
{{- end }}

{{- define "partials/fediscuss/js.html" -}}
    {{- with resources.Get "js/fediscuss.js" }}
        {{- with resources.ExecuteAsTemplate "fediscuss.js" $ . | minify }}
            {{- $js := . }}
            {{- if eq hugo.Environment "development" }}
                <script src="{{ $js.Permalink }}" defer></script>
            {{- else }}
                {{- with . | fingerprint "sha256" }}
                    <script src="{{ $js.Permalink }}"
                        integrity="{{ .Data.Integrity }}" crossorigin="anonymous"
                        defer></script>
                {{- end }}
            {{- end }}
        {{- end }}
    {{- end }}
{{- end }}

{{- define "partials/fediverse/meta.html" -}}
    {{- $bsky := or .Params.skeet .Params.bsky .Params.bluesky }}
    {{- $toot := or .Params.toot .Params.comment }}
    {{- $toots := split (replaceRE "^https?://" "" $toot) "/" }}
    {{- $host := index $toots 0 }}
    {{- $user := trim (index $toots 1) "@" }}
    {{- if and $host $user }}
        <meta name="mastodon:creator" content="{{ print "@" $user "@" $host }}">
    {{- end }}
    {{/*  {{- if or $toot $bsky -}}
        {{- $fediscuss := resources.Get "css/hugo-foxx/fediscuss.css" | minify  }}
        {{- if eq hugo.Environment "development" }}
            <link rel="stylesheet" href="{{ $fediscuss.Permalink }}">
        {{- else }}
            {{- with $fediscuss | fingerprint "sha256" }}
                <link rel="stylesheet" href="{{ $fediscuss.Permalink }}" integrity="{{ .Data.Integrity }}" crossorigin="anonymous">
            {{- end }}
        {{- end }}
    {{- end }}  */}}
{{- end }}