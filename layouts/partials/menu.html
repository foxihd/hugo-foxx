{{ "<!-- menu.html -->" | safeHTML }}
{{- $menuID := .menuID }}
{{- $page := .page }}
{{- $main := eq $menuID "main" }}
{{- $type := .type }}

{{- if $main }}
<input id="menu" type="checkbox" aria-controls="{{ printf "%s-menu" $menuID }}" style="display:none;" hidden>
<label for="menu" class="icon menu" aria-controls="{{ printf "%s-menu" $menuID }}"><span class="hide">{{ i18n "main" }}</span>{{ if $page.Params.toc }}<span class="textssc">toc</span>{{ end }}</label>
{{- end }}

{{- with index site.Menus $menuID }}
    <nav id="{{ printf "%s-menu" $menuID }}" {{ with $type}}class="{{ . }}"{{ end }} {{ with  (i18n $menuID) }}aria-label="{{ i18n "nav" }}{{ i18n $menuID }}" {{ end }}>
        {{- if $main }}<strong>{{ i18n "onThisSite" }}</strong>{{ end }}
        {{- if eq $type "author" }}<strong>{{ i18n "keepInTouch" }}</strong>{{ end }}
        {{- $n := 1 }}
        {{- $no := printf "l%d" $n }}
        {{- $hasChildFree := partial "menu/hasChildFree.html" (dict "menuEntries" .) }}
        <ul class="{{ $no }} {{ if $hasChildFree }} has-childfree {{ end }}" role="presentation" tabindex="-1" >
            {{ partial "inline/menu/walk.html" (dict "page" $page "menuID" $menuID "n" $n "menuEntries" .) }}
        </ul>
    </nav>
{{- end }}

{{- /*---------------------- end of menu.html ----------------------*/}}

{{- define "partials/menu/hasChildFree.html"}}
    {{- $hasChildFree := true }}
    {{- range .menuEntries }}
        {{- if .Children }}
            {{- $hasChildFree = false }}
        {{- end }}
    {{- end }}
    {{ return $hasChildFree }}
{{- end }}

{{- define "partials/inline/menu/walk.html" -}}
    {{- $page := .page }}
    {{- $menuID := .menuID }}
    {{- $main := eq $menuID "main" }}
    {{- $n := .n }}
    {{- $n = add $n 1 }}
    {{- $l := printf "l%d" $n }}
    {{- $deck := and $main (eq $n 2) }}
    {{ range .menuEntries -}}
        {{- $name := .Name }}
        {{- $class := .Params.class }}
        {{- $hasDestination := false }}
        {{- if or .URL .PageRef }}
            {{- $hasDestination = true }}
        {{- end }}
        {{- $attrs := dict "href" .URL }}
        {{- if $page.IsMenuCurrent .Menu . }}
            {{- $attrs = merge $attrs (dict "aria-current" "page") }}
        {{- else if $page.HasMenuCurrent .Menu . }}
            {{- $attrs = merge $attrs (dict "aria-current" "true") }}
        {{- end }}
        {{- $desc := .Post }}
        {{- if $desc }}
            {{- $attrs = merge $attrs (dict "class" "has-desc") }}
        {{- end }}
        {{- $icon := .Pre }}
        {{- $u := urls.Parse .URL -}}
        {{- $identifier := .Identifier }}
        {{- with $identifier }}
            {{- if not $name }}
                {{- $attrs = merge $attrs (dict "title" . "aria-label" .) }}
            {{- end }}
        {{- end }}
        <li role="presentation" {{ with $class }}class="{{ . }}"{{ end }}>
            {{- if .Children }}
                {{- template "menuItemWithChildren" dict "item" . "attrs" $attrs "link" $hasDestination "icon" $icon "name" $name "desc" $desc "menuID" $menuID "l" $l "n" $n "page" $page }}
            {{- else }}
                {{- template "menuItem" dict "attrs" $attrs "name" $name "desc" $desc "icon" $icon "identifier" $identifier "u" $u }}
            {{- end }}
        </li>
    {{- end }}
{{- end }}

{{- define "menuItem" }}
    <a  {{ range $key, $val := .attrs }}
            {{- with $val }}
                {{- printf " %s=%s" $key $val | safeHTMLAttr }}
            {{- end }}
        {{- end }}
        {{- if .desc }}
            aria-label="{{ .name }}"
            aria-description="{{ .desc }}"
        {{- end -}}
        {{- if .u.IsAbs }}
            target="_blank"
            rel="external noopener noreferrer nofollow"
        {{- end }}
        >
        {{- if and .icon (not .desc) }}
            <i class="icon">{{ .icon }}</i>
        {{- end }}
        {{- if .name }}
            <span>
                {{- if and .icon .desc }}
                    <i class="icon" aria-hidden="true">{{ .icon }}</i>
                {{- end }}
                {{ .name -}}
            </span>
        {{- end }}
    </a>
{{- end }}

{{- define "menuItemWithChildren" }}
    <details>
        <summary>
            {{- if and .icon (not .desc) }}
                <i class="icon">{{ .icon }}</i>
            {{- end }}
            <span {{ with .desc }} class="has-aria-label" aria-label="{{ . }}" {{ end }}>
                {{- if and .icon .desc }}
                    <i class="icon" aria-hidden="true">{{ .icon }}</i>
                {{- end }}
                {{- .name -}}
            </span>
        </summary>
        <ul class="{{ .l }}" role="presentation">
            {{ partial "inline/menu/walk.html" (dict "page" .page "n" .n "menuEntries" .item.Children) }}
            {{- if .hasDestination }}
                <li class="parent-anchor">
                    <a  {{- range $key, $val := .attrs }}
                            {{- printf " %s=%s" $key $val | safeHTMLAttr }}
                        {{- end }}
                        aria-label="{{ i18n "seeAll" }}:{{ $.name }}">
                        {{ with $.icon }}<i class="icon" aria-hidden="true">{{ . }}</i>{{ end }}
                        <span aria-hidden="true"> {{ $.name }}</span>
                    </a>
                </li>
            {{- end }}
        </ul>
    </details>
{{- end }}